<!DOCTYPE html>
<html>
<head>
  <title>Storage Test</title>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 900px; margin: 0 auto; }
    button { margin: 5px; padding: 10px; font-size: 14px; cursor: pointer; }
    pre { background: #f0f0f0; padding: 15px; border-radius: 4px; overflow-x: auto; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    h2 { margin-top: 30px; border-bottom: 2px solid #333; padding-bottom: 5px; }
  </style>
</head>
<body>
  <h1>NCADbook Storage & Login Test</h1>

  <h2>Step 1: Check Browser Console</h2>
  <p>Press F12 to open Developer Tools, then check the Console tab for errors.</p>

  <h2>Step 2: LocalStorage Test</h2>
  <button onclick="testStorage()">Test LocalStorage Access</button>
  <button onclick="viewStorage()">View Storage Data</button>
  <button onclick="clearAll()">Clear All Data</button>
  <pre id="output"></pre>

  <script>
    function log(msg, isError = false) {
      const output = document.getElementById('output');
      const className = isError ? 'error' : 'success';
      output.innerHTML += `<span class="${className}">${msg}</span>\n`;
    }

    function testStorage() {
      const output = document.getElementById('output');
      output.innerHTML = '';

      try {
        // Test if localStorage works
        localStorage.setItem('test', 'works');
        const test = localStorage.getItem('test');
        localStorage.removeItem('test');

        if (test === 'works') {
          log('✓ LocalStorage is working!');
        } else {
          log('✗ LocalStorage read/write failed', true);
          return;
        }

        // Check for NCADbook data
        const data = localStorage.getItem('ncadbook_demo_data');

        if (!data) {
          log('⚠ No NCADbook data found - initializing...');
          initializeDemoData();
        } else {
          log('✓ NCADbook data exists');
          const parsed = JSON.parse(data);
          log(`  - Users: ${parsed.users?.length || 0}`);
          log(`  - Equipment: ${parsed.equipment?.length || 0}`);
          log(`  - Current User: ${parsed.currentUser?.email || 'None'}`);
        }
      } catch (error) {
        log('✗ Error: ' + error.message, true);
        console.error(error);
      }
    }

    function initializeDemoData() {
      const demoUsers = [
        { id: '1', email: 'master@ncad.ie', password: 'master123', first_name: 'Master', surname: 'Admin', full_name: 'Master Admin', role: 'master_admin', department: 'Administration', created_at: '2024-01-01' },
        { id: '2', email: 'admin@ncad.ie', password: 'admin123', first_name: 'Admin', surname: 'User', full_name: 'Admin User', role: 'admin', department: 'Moving Image', created_at: '2024-01-01' },
        { id: '3', email: 'staff@ncad.ie', password: 'staff123', first_name: 'Staff', surname: 'Member', full_name: 'Staff Member', role: 'staff', department: 'Moving Image', created_at: '2024-01-01' },
        { id: '4', email: 'demo@ncad.ie', password: 'demo123', first_name: 'Demo', surname: 'Student', full_name: 'Demo Student', role: 'student', department: 'Moving Image', created_at: '2024-01-01' },
      ];

      const demoEquipment = [
        { id: 'eq1', product_name: 'Canon EOS R5', tracking_number: 'CAM-R5-001', category: 'Camera', description: 'Professional mirrorless camera', department: 'Moving Image', status: 'available', link_to_image: '/images/equipment/canon-r5.jpg', requires_justification: true },
        { id: 'eq2', product_name: 'Sony FX3', tracking_number: 'CAM-FX3-001', category: 'Camera', description: 'Cinema camera', department: 'Moving Image', status: 'available', link_to_image: '/images/equipment/sony-fx3.jpg', requires_justification: true },
      ];

      const initialData = {
        users: demoUsers,
        equipment: demoEquipment,
        spaces: [],
        bookings: [],
        spaceBookings: [],
        featureFlags: [
          { id: 'ff1', name: 'room_booking', enabled: true, description: 'Enable room booking', required_role: 'staff' }
        ],
        currentUser: null
      };

      localStorage.setItem('ncadbook_demo_data', JSON.stringify(initialData));
      log('✓ Demo data initialized successfully!');
    }

    function viewStorage() {
      const output = document.getElementById('output');
      output.innerHTML = '';

      const data = localStorage.getItem('ncadbook_demo_data');
      if (!data) {
        log('No data found', true);
        return;
      }

      try {
        const parsed = JSON.parse(data);
        output.innerHTML = '<span class="success">Current Storage Data:</span>\n' +
                          JSON.stringify(parsed, null, 2);
      } catch (error) {
        log('Error parsing data: ' + error.message, true);
      }
    }

    function clearAll() {
      localStorage.removeItem('ncadbook_demo_data');
      document.getElementById('output').innerHTML = '<span class="success">✓ All data cleared</span>';
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      testStorage();
    });
  </script>
</body>
</html>
